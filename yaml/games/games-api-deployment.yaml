apiVersion: apps/v1
kind: Deployment
metadata:
  name: games-api
  namespace: fcg
  labels:
    app: games-api
    app.kubernetes.io/name: games-api
    app.kubernetes.io/part-of: fcg
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: games-api
  template:
    metadata:
      labels:
        app: games-api
        app.kubernetes.io/name: games-api
    spec:
      serviceAccountName: games-api-sa
      volumes:
        - name: appsettings
          secret:
            secretName: games-appsettings
            items:
              - key: appsettings.Production.json
                path: appsettings.Production.json
      containers:
        - name: games-api
          image: 399349187224.dkr.ecr.us-east-1.amazonaws.com/fcg-games-api:latest
          imagePullPolicy: Always
          ports:
            - containerPort: 8080
              protocol: TCP
          env:
            - name: ASPNETCORE_ENVIRONMENT
              valueFrom:
                configMapKeyRef:
                  name: fcg-config
                  key: ASPNETCORE_ENVIRONMENT
            - name: ELASTIC_ENABLED
              value: "true"
            - name: ELASTIC_URL
              value: "http://elasticsearch:9200"
            - name: ELASTIC_INDEX_NAME
              value: "games"
            - name: Logging__LogLevel__Microsoft.AspNetCore.Hosting.Diagnostics
              value: Warning
            - name: Logging__LogLevel__Microsoft.AspNetCore.Routing.EndpointMiddleware
              value: Warning
            - name: Logging__LogLevel__Microsoft.AspNetCore.Http.Result
              value: Warning
            - name: OTEL_TRACES_SAMPLER
              valueFrom:
                configMapKeyRef:
                  name: fcg-config
                  key: OTEL_TRACES_SAMPLER
            - name: OTEL_EXPORTER_OTLP_ENDPOINT
              value: http://adot-collector.fcg.svc.cluster.local:4317
            - name: OTEL_EXPORTER_OTLP_PROTOCOL
              value: grpc
            - name: OTEL_SERVICE_NAME
              value: games-api
          volumeMounts:
            - name: appsettings
              mountPath: /app/appsettings.Production.json
              subPath: appsettings.Production.json
          resources:
            requests:
              memory: "128Mi"
              cpu: "50m"
            limits:
              memory: "512Mi"
              cpu: "500m"
          livenessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 15
            periodSeconds: 300
            timeoutSeconds: 5
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /ready
              port: 8080
            initialDelaySeconds: 5
            periodSeconds: 300
            timeoutSeconds: 3
            failureThreshold: 3
---
apiVersion: v1
kind: Service
metadata:
  name: games-api-service
  namespace: fcg
  labels:
    app: games-api
    app.kubernetes.io/name: games-api
    app.kubernetes.io/part-of: fcg
spec:
  type: LoadBalancer
  selector:
    app: games-api
  ports:
    - name: http
      port: 80
      targetPort: 8080
      protocol: TCP


